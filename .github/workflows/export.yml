name: Export to HTML5 and Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Download Godot 4.3 (LTS)
        run: |
          mkdir -p ${{ github.workspace }}/godot
          cd ${{ github.workspace }}/godot
          wget -q https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_linux.x86_64.zip
          unzip -q Godot_v4.3-stable_linux.x86_64.zip
          chmod +x Godot_v4.3-stable_linux.x86_64

      - name: Download HTML5 Export Templates
        run: |
          mkdir -p ~/.local/share/godot/export_templates/4.3.stable
          cd ~/.local/share/godot/export_templates/4.3.stable
          wget -q https://github.com/godotengine/godot-builds/releases/download/4.3-stable/Godot_v4.3-stable_web_templates.tpz
          unzip -q Godot_v4.3-stable_web_templates.tpz
          rm Godot_v4.3-stable_web_templates.tpz

      - name: Export Project to HTML5
        run: |
          mkdir -p ${{ github.workspace }}/docs
          ${{ github.workspace }}/godot/Godot_v4.3-stable_linux.x86_64 \
            --headless \
            --export-release "HTML5 WebXR" \
            --path ${{ github.workspace }} \
            ${{ github.workspace }}/docs/index.html

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: html5-export
          path: ${{ github.workspace }}/docs/

      - name: Commit and push docs to main branch
        run: |
          cd ${{ github.workspace }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/
          git commit -m "Deploy: Godot HTML5 WebXR export" || echo "No changes to commit"
          git push origin main || echo "Push skipped"

      - name: Output deployment info
        run: |
          echo "ðŸŽ‰ Export successful!"
          echo "Repository: project67sigma-a11y/vrproject"
          echo "GitHub Pages is enabled for the 'docs' folder on main branch"
          echo "View at: https://project67sigma-a11y.github.io/vrproject/"

